<!DOCTYPE html>
<html>
  <head>
    <title>IPFS Live Streaming</title>
    <script src="https://unpkg.com/ipfs/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://unpkg.com/hlsjs-ipfs-loader@0.1.2/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.js"></script>
    

    <!-- loading the minified version -->
    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>

    <!-- loading the human-readable (not minified) version -->
    <script src="https://unpkg.com/ipfs/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.js"></script>
  </head>
  
  <body>
  
    <video id="video" controls></video> 
  
  </body>
  <script type="text/javascript"> 
    
    // Create new ipfs node from api with pubsub true
    const ipfs = new window.Ipfs({
	    EXPERIMENTAL: {
	    	pubsub: true
	  }
	});

    //Topic to subscribe to get new hash
	const topic = 'newHash'

 //    ipfs.once('ready', (err) ipfs.id() => {
	// 	// const receiveMsg = (msg) => console.log("message:::::"+msg.data.toString());

	// 	// ipfs.pubsub.subscribe(topic, receiveMsg, (err) => {
	// 	//   if (err) {
	// 	//     return console.error(`failed to subscribe to ${topic}`, err)
	// 	//   }
	// 	//   console.log(`subscribed to ${topic}`)
	// 	// })

	// 	if(err){
	// 		throw()
	// 	}
	// })

	ipfs.once('ready', () => ipfs.id((error, info) => {
		// node is ready
		if(error){throw err}

		// If no error	
		console.log("IPFS is ready");
		
		// Subscribe to topic "newHash"
		ipfs.pubsub.subscribe(topic, (message) => {
		  console.log('got message from ' + message.from)

		  // data is a buffer. Here we're converting it into a string

		  const data = message.data.toString()
		  console.log('containing data: ' + data)
		})

		

	}));

	// test to publish
	setTimeout(() => {
          ipfs.pubsub.publish(topic, new ipfs.types.Buffer('banana'))
    }, 2000)
	
    



// 	const recieveMsg = (hash) => {
// 		//var testhash = "QmS1SpRjhbNuqj8FUQYCe8i6agnQtHQAXKWiRWxL9HVs2S";
// 		var testhash = hash;		
// 		console.log(testhash);
// 		//Hls.DefaultConfig.loader = HlsjsIpfsLoader;
// 		//Hls.DefaultConfig.debug = false;

// 		//if(Hls.isSupported()) {

// 		//	var video = document.getElementById('video');
// //
// //			var hls = new Hls();
// //
// //			hls.config.ipfs = ipfs;
// //			hls.config.ipfsHash = testhash;
// //
// //			hls.loadSource('master.m3u8');
// //
// //			hls.attachMedia(video);
// //
// //
// //			hls.on(Hls.Events.MANIFEST_PARSED, () => {
// //				video.play();
// //			});
// //		}	
// //	
// 	}


// 	// topic = "newHash";

//     // ipfs.pubsub.subscribe(topic, recieveMsg, (error) => {
//     // 	if(error){
//     // 		console.log("failed: ", error);		
//     // 	}else{
//     // 		console.log("Subscribed");	
//     // 	}
    		
//     // });

//     console.log(ipfs.pubsub.subscribe);
	

    // })
  </script>
</html>
